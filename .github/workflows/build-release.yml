name: Build & Release TrueAsync PHP

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      test_only:
        description: 'Test build only (no release, no artifacts saved)'
        required: false
        default: true
        type: boolean

permissions:
  contents: write

jobs:
  # ---------------------------------------------------------------------------
  # Read build configuration
  # ---------------------------------------------------------------------------
  config:
    runs-on: ubuntu-latest
    outputs:
      php_src_repo: ${{ steps.read.outputs.php_src_repo }}
      php_src_branch: ${{ steps.read.outputs.php_src_branch }}
      async_repo: ${{ steps.read.outputs.async_repo }}
      async_branch: ${{ steps.read.outputs.async_branch }}
      xdebug_repo: ${{ steps.read.outputs.xdebug_repo }}
      xdebug_branch: ${{ steps.read.outputs.xdebug_branch }}
      version: ${{ steps.read.outputs.version }}
      php_version: ${{ steps.read.outputs.php_version }}
      is_prerelease: ${{ steps.read.outputs.is_prerelease }}
    steps:
      - uses: actions/checkout@v4

      - name: Read build-config.json
        id: read
        run: |
          echo "php_src_repo=$(jq -r '.php_src.repo' build-config.json)" >> "$GITHUB_OUTPUT"
          echo "php_src_branch=$(jq -r '.php_src.branch' build-config.json)" >> "$GITHUB_OUTPUT"
          echo "async_repo=$(jq -r '.extensions.async.repo' build-config.json)" >> "$GITHUB_OUTPUT"
          echo "async_branch=$(jq -r '.extensions.async.branch' build-config.json)" >> "$GITHUB_OUTPUT"
          echo "xdebug_repo=$(jq -r '.extensions.xdebug.repo' build-config.json)" >> "$GITHUB_OUTPUT"
          echo "xdebug_branch=$(jq -r '.extensions.xdebug.branch' build-config.json)" >> "$GITHUB_OUTPUT"
          echo "php_version=$(jq -r '.php_version' build-config.json)" >> "$GITHUB_OUTPUT"
          VERSION="${GITHUB_REF_NAME#v}"
          if [[ "$VERSION" == "$GITHUB_REF_NAME" ]]; then
            VERSION="dev-$(date +%Y%m%d-%H%M%S)"
            echo "is_prerelease=false" >> "$GITHUB_OUTPUT"
          else
            if [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+-(alpha|beta|rc) ]]; then
              echo "is_prerelease=true" >> "$GITHUB_OUTPUT"
            else
              echo "is_prerelease=false" >> "$GITHUB_OUTPUT"
            fi
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

  # ---------------------------------------------------------------------------
  # Linux x64 build (disabled — binary is not portable across distros)
  # ---------------------------------------------------------------------------
  # build-linux:
  #   needs: config
  #   runs-on: ubuntu-22.04
  #   timeout-minutes: 60
  #   steps:
  #     - uses: actions/checkout@v4
  #
  #     - name: Checkout php-src
  #       uses: actions/checkout@v4
  #       with:
  #         repository: ${{ needs.config.outputs.php_src_repo }}
  #         ref: ${{ needs.config.outputs.php_src_branch }}
  #         path: php-src
  #
  #     - name: Checkout ext/async
  #       uses: actions/checkout@v4
  #       with:
  #         repository: ${{ needs.config.outputs.async_repo }}
  #         ref: ${{ needs.config.outputs.async_branch }}
  #         path: php-src/ext/async
  #
  #     - name: Checkout xdebug
  #       uses: actions/checkout@v4
  #       with:
  #         repository: ${{ needs.config.outputs.xdebug_repo }}
  #         ref: ${{ needs.config.outputs.xdebug_branch }}
  #         path: xdebug
  #
  #     - name: Install dependencies
  #       run: |
  #         sudo apt-get update
  #         sudo apt-get install -y \
  #           autoconf automake bison re2c pkg-config \
  #           build-essential curl cmake ninja-build \
  #           libxml2-dev libsqlite3-dev libcurl4-openssl-dev \
  #           libssl-dev libzip-dev zlib1g-dev \
  #           libpq-dev libonig-dev libsodium-dev \
  #           libreadline-dev libbz2-dev \
  #           libgmp-dev libicu-dev libxslt1-dev \
  #           libjpeg-dev libwebp-dev libfreetype6-dev libpng-dev \
  #           libtidy-dev libldap2-dev \
  #           libgettextpo-dev libargon2-dev
  #
  #         # Build libuv 1.48.0 from source
  #         wget https://github.com/libuv/libuv/archive/v1.48.0.tar.gz
  #         tar -xzf v1.48.0.tar.gz
  #         cd libuv-1.48.0
  #         mkdir build && cd build
  #         cmake .. -G Ninja -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTING=OFF
  #         ninja
  #         sudo ninja install
  #         sudo ldconfig
  #         cd ../..
  #
  #         # Build libcurl 8.5.0 from source (need >= 7.87.0 for TrueAsync)
  #         wget https://github.com/curl/curl/releases/download/curl-8_5_0/curl-8.5.0.tar.gz
  #         tar -xzf curl-8.5.0.tar.gz
  #         cd curl-8.5.0
  #         ./configure --prefix=/usr/local --with-openssl --enable-shared --disable-static
  #         make -j$(nproc)
  #         sudo make install
  #         sudo ldconfig
  #
  #     - name: Build PHP
  #       working-directory: php-src
  #       run: |
  #         COMMON_FLAGS=$(jq -r '.configure.common | join(" ")' ../build-config.json)
  #         LINUX_FLAGS=$(jq -r '.configure.linux | join(" ")' ../build-config.json)
  #
  #         ./buildconf --force
  #         ./configure \
  #           --prefix=/opt/php-trueasync \
  #           $COMMON_FLAGS \
  #           $LINUX_FLAGS
  #
  #         make -j$(nproc)
  #
  #     - name: Run ext/async tests
  #       working-directory: php-src
  #       run: |
  #         PHP_BIN="$(pwd)/sapi/cli/php"
  #         echo "Running ext/async tests..."
  #         "$PHP_BIN" run-tests.php --show-diff -p "$PHP_BIN" ext/async/tests/
  #         echo "All ext/async tests passed."
  #
  #     - name: Install PHP
  #       working-directory: php-src
  #       run: |
  #         sudo make install
  #
  #     - name: Build xdebug
  #       working-directory: xdebug
  #       run: |
  #         /opt/php-trueasync/bin/phpize
  #         ./configure --with-php-config=/opt/php-trueasync/bin/php-config
  #         make -j$(nproc)
  #         sudo make install
  #
  #     - name: Verify build
  #       run: |
  #         /opt/php-trueasync/bin/php -v
  #         /opt/php-trueasync/bin/php -m
  #
  #     - name: Package
  #       run: |
  #         VERSION="${{ needs.config.outputs.version }}"
  #         ARCHIVE="php-trueasync-${VERSION}-linux-x64.tar.gz"
  #
  #         cd /opt
  #         tar czf "${GITHUB_WORKSPACE}/${ARCHIVE}" php-trueasync/
  #         echo "ARCHIVE=${ARCHIVE}" >> "$GITHUB_ENV"
  #
  #     - name: Upload artifact
  #       if: ${{ !inputs.test_only }}
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: linux-x64
  #         path: ${{ env.ARCHIVE }}
  #         retention-days: 5

  # ---------------------------------------------------------------------------
  # Windows x64 build (Release + Debug via matrix)
  # ---------------------------------------------------------------------------
  build-windows:
    name: "Windows x64 (${{ matrix.build_type }})"
    needs: config
    runs-on: windows-2022
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        include:
          - build_type: Release
            output_dir: Release_TS
            configure_flags: "--enable-snapshot-build --disable-debug-pack"
            install_prefix: "C:\\php-trueasync"
            artifact_suffix: ""
          - build_type: Debug
            output_dir: Debug_TS
            configure_flags: "--enable-debug"
            install_prefix: "C:\\php-trueasync-debug"
            artifact_suffix: "-debug"
    env:
      PHP_BUILD_CACHE_BASE_DIR: C:\build-cache
      PHP_BUILD_OBJ_DIR: C:\obj
      PHP_BUILD_CACHE_SDK_DIR: C:\build-cache\sdk
      PHP_BUILD_SDK_BRANCH: php-sdk-2.3.0
      PHP_BUILD_CRT: vs17
      PLATFORM: x64
      THREAD_SAFE: "1"
    steps:
      - name: git config
        run: git config --global core.autocrlf false && git config --global core.eol lf

      - uses: actions/checkout@v4

      - name: Checkout php-src
        uses: actions/checkout@v4
        with:
          repository: ${{ needs.config.outputs.php_src_repo }}
          ref: ${{ needs.config.outputs.php_src_branch }}
          path: php-src

      - name: Checkout ext/async
        uses: actions/checkout@v4
        with:
          repository: ${{ needs.config.outputs.async_repo }}
          ref: ${{ needs.config.outputs.async_branch }}
          path: async

      - name: Copy async extension to ext/async
        shell: cmd
        run: |
          if not exist php-src\ext\async mkdir php-src\ext\async
          xcopy /E /I /H /Y async php-src\ext\async

      - name: Checkout xdebug
        uses: actions/checkout@v4
        with:
          repository: ${{ needs.config.outputs.xdebug_repo }}
          ref: ${{ needs.config.outputs.xdebug_branch }}
          path: xdebug

      - name: Setup LibUV
        shell: powershell
        run: |
          if (!(Test-Path "C:\vcpkg")) {
            git clone https://github.com/Microsoft/vcpkg.git C:\vcpkg
            C:\vcpkg\bootstrap-vcpkg.bat
          }
          C:\vcpkg\vcpkg.exe install libuv:x64-windows

      - name: Setup PHP SDK
        shell: cmd
        run: |
          if not exist "%PHP_BUILD_CACHE_BASE_DIR%" mkdir "%PHP_BUILD_CACHE_BASE_DIR%"
          if not exist "%PHP_BUILD_OBJ_DIR%" mkdir "%PHP_BUILD_OBJ_DIR%"
          git clone --branch %PHP_BUILD_SDK_BRANCH% --depth 1 https://github.com/php/php-sdk-binary-tools.git "%PHP_BUILD_CACHE_SDK_DIR%"

      - name: Detect PHP branch and download deps
        shell: cmd
        run: |
          cd php-src
          for /f "usebackq tokens=3" %%i in (`findstr PHP_MAJOR_VERSION main\php_version.h`) do set BRANCH=%%i
          for /f "usebackq tokens=3" %%i in (`findstr PHP_MINOR_VERSION main\php_version.h`) do set BRANCH=%BRANCH%.%%i
          if /i "%BRANCH%" equ "8.5" set BRANCH=master

          echo BRANCH=%BRANCH%>> %GITHUB_ENV%

          set DEPS_DIR=%PHP_BUILD_CACHE_BASE_DIR%\deps-%BRANCH%-%PHP_BUILD_CRT%-%PLATFORM%
          echo DEPS_DIR=%DEPS_DIR%>> %GITHUB_ENV%

          set SDK_RUNNER=%PHP_BUILD_CACHE_SDK_DIR%\phpsdk-%PHP_BUILD_CRT%-%PLATFORM%.bat

          REM Create task script for downloading deps
          > %GITHUB_WORKSPACE%\task_deps.bat echo @echo off
          >> %GITHUB_WORKSPACE%\task_deps.bat echo phpsdk_deps --update --no-backup --branch %BRANCH% --stability staging --deps %DEPS_DIR% --crt %PHP_BUILD_CRT%
          >> %GITHUB_WORKSPACE%\task_deps.bat echo if %%errorlevel%% neq 0 exit /b 3

          cmd /c %SDK_RUNNER% -t %GITHUB_WORKSPACE%\task_deps.bat
          if %errorlevel% neq 0 exit /b %errorlevel%

          REM Copy LibUV from vcpkg to deps directory
          if not exist "%DEPS_DIR%\include\libuv" mkdir "%DEPS_DIR%\include\libuv"
          if not exist "%DEPS_DIR%\lib" mkdir "%DEPS_DIR%\lib"
          if not exist "%DEPS_DIR%\bin" mkdir "%DEPS_DIR%\bin"
          copy "C:\vcpkg\installed\x64-windows\include\uv.h" "%DEPS_DIR%\include\libuv\uv.h"
          xcopy /E /I /H /Y "C:\vcpkg\installed\x64-windows\include\uv" "%DEPS_DIR%\include\libuv\uv\"
          copy "C:\vcpkg\installed\x64-windows\lib\uv.lib" "%DEPS_DIR%\lib\libuv.lib"
          copy "C:\vcpkg\installed\x64-windows\bin\uv.dll" "%DEPS_DIR%\bin\uv.dll"

      - name: Create build task script
        shell: pwsh
        run: |
          $prefix = "${{ matrix.install_prefix }}"
          $flags = "${{ matrix.configure_flags }}"
          @(
            "@echo off",
            "cd /d $($env:GITHUB_WORKSPACE)\php-src",
            "if %errorlevel% neq 0 exit /b 3",
            "call buildconf.bat --force",
            "if %errorlevel% neq 0 exit /b 3",
            "call configure.bat $flags --enable-object-out-dir=%PHP_BUILD_OBJ_DIR% --with-php-build=%DEPS_DIR% --enable-async --with-prefix=$prefix",
            "if %errorlevel% neq 0 exit /b 3",
            "nmake /NOLOGO",
            "if %errorlevel% neq 0 exit /b 3",
            "exit /b 0"
          ) | Set-Content -Path "$env:GITHUB_WORKSPACE\task_build.bat" -Encoding ASCII

      - name: Build PHP
        shell: cmd
        run: |
          set SDK_RUNNER=%PHP_BUILD_CACHE_SDK_DIR%\phpsdk-%PHP_BUILD_CRT%-%PLATFORM%.bat
          cmd /c %SDK_RUNNER% -t %GITHUB_WORKSPACE%\task_build.bat
          if %errorlevel% neq 0 exit /b %errorlevel%

      - name: Run ext/async tests
        shell: cmd
        run: |
          set PHP_BIN=%PHP_BUILD_OBJ_DIR%\${{ matrix.output_dir }}\php.exe

          REM Copy dependency DLLs next to php.exe so it can find them
          copy "%DEPS_DIR%\bin\*.dll" "%PHP_BUILD_OBJ_DIR%\${{ matrix.output_dir }}\"

          echo Running ext/async tests...
          "%PHP_BIN%" php-src\run-tests.php --show-diff -p "%PHP_BIN%" php-src\ext\async\tests\
          if %errorlevel% neq 0 exit /b %errorlevel%
          echo All ext/async tests passed.

      - name: Create install task script
        shell: pwsh
        run: |
          @(
            "@echo off",
            "cd /d $($env:GITHUB_WORKSPACE)\php-src",
            "if %errorlevel% neq 0 exit /b 3",
            "nmake install",
            "if %errorlevel% neq 0 exit /b 3",
            "exit /b 0"
          ) | Set-Content -Path "$env:GITHUB_WORKSPACE\task_install.bat" -Encoding ASCII

      - name: Install PHP
        shell: cmd
        run: |
          set SDK_RUNNER=%PHP_BUILD_CACHE_SDK_DIR%\phpsdk-%PHP_BUILD_CRT%-%PLATFORM%.bat
          cmd /c %SDK_RUNNER% -t %GITHUB_WORKSPACE%\task_install.bat
          if %errorlevel% neq 0 exit /b %errorlevel%

      - name: Create xdebug build task script
        shell: pwsh
        run: |
          $installPrefix = "${{ matrix.install_prefix }}"
          # Find phpize.bat
          $phpize = "$installPrefix\SDK\phpize.bat"
          if (!(Test-Path $phpize)) { $phpize = "$installPrefix\devel\phpize.bat" }
          if (!(Test-Path $phpize)) {
            $found = Get-ChildItem -Path "$installPrefix" -Recurse -Filter "phpize.bat" -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($found) { $phpize = $found.FullName }
            else { Write-Error "phpize.bat not found"; exit 1 }
          }
          @(
            "@echo off",
            "cd /d $($env:GITHUB_WORKSPACE)\xdebug",
            "if %errorlevel% neq 0 exit /b 3",
            "call `"$phpize`"",
            "if %errorlevel% neq 0 exit /b 3",
            "call configure.bat --with-php-build=%DEPS_DIR% --enable-xdebug",
            "if %errorlevel% neq 0 exit /b 3",
            "nmake /NOLOGO",
            "if %errorlevel% neq 0 exit /b 3",
            "nmake install",
            "if %errorlevel% neq 0 exit /b 3",
            "exit /b 0"
          ) | Set-Content -Path "$env:GITHUB_WORKSPACE\task_xdebug.bat" -Encoding ASCII

      - name: Build xdebug
        shell: cmd
        run: |
          set SDK_RUNNER=%PHP_BUILD_CACHE_SDK_DIR%\phpsdk-%PHP_BUILD_CRT%-%PLATFORM%.bat
          cmd /c %SDK_RUNNER% -t %GITHUB_WORKSPACE%\task_xdebug.bat
          if %errorlevel% neq 0 exit /b %errorlevel%

      - name: Package
        run: |
          $version = "${{ needs.config.outputs.version }}"
          $phpVersion = "${{ needs.config.outputs.php_version }}"
          $suffix = "${{ matrix.artifact_suffix }}"
          $installPrefix = "${{ matrix.install_prefix }}"
          $archive = "php-trueasync-${version}-php${phpVersion}-windows-x64${suffix}.zip"

          # Copy libuv DLL to the install directory
          if (Test-Path "$env:DEPS_DIR\bin\uv.dll") {
            Copy-Item "$env:DEPS_DIR\bin\uv.dll" "${installPrefix}\" -ErrorAction SilentlyContinue
          }

          Compress-Archive -Path "${installPrefix}\*" -DestinationPath "${env:GITHUB_WORKSPACE}\${archive}"
          echo "ARCHIVE=${archive}" >> $env:GITHUB_ENV
        shell: pwsh

      - name: Upload artifact
        if: ${{ !inputs.test_only }}
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64${{ matrix.artifact_suffix }}
          path: ${{ env.ARCHIVE }}
          retention-days: 5

  # ---------------------------------------------------------------------------
  # Create GitHub Release with checksums
  # ---------------------------------------------------------------------------
  release:
    if: ${{ !inputs.test_only }}
    needs: [config, build-windows]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Collect release files
        run: |
          mkdir -p release-files
          find artifacts -type f \( -name "*.tar.gz" -o -name "*.zip" \) -exec cp {} release-files/ \;
          ls -la release-files/

      - name: Generate SHA256 checksums
        run: |
          cd release-files
          sha256sum * > sha256sums.txt
          cat sha256sums.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          prerelease: ${{ needs.config.outputs.is_prerelease == 'true' }}
          name: "TrueAsync PHP ${{ needs.config.outputs.version }} (php${{ needs.config.outputs.php_version }})"
          body: |
            ## TrueAsync PHP ${{ needs.config.outputs.version }} (php${{ needs.config.outputs.php_version }})

            PHP with built-in TrueAsync support and Xdebug.

            ### Included extensions
            - **async** — TrueAsync coroutine engine
            - **xdebug** — Debugger and profiler

            ### Downloads
            - **Release** build — for general use
            - **Debug** build — for PHP/extension development (includes debug symbols and assertions)

            ### Installation

            **Windows (PowerShell):**
            ```powershell
            irm https://raw.githubusercontent.com/true-async/releases/main/installer/install.ps1 | iex
            ```

            ### Verify
            ```powershell
            php -v
            php -m | findstr async
            ```

            ### Checksums
            See `sha256sums.txt` for SHA256 checksums of all files.
          files: release-files/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
