name: Build & Release TrueAsync PHP

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      test_only:
        description: 'Test build only (no release, no artifacts saved)'
        required: false
        default: true
        type: boolean

permissions:
  contents: write

jobs:
  # ---------------------------------------------------------------------------
  # Read build configuration
  # ---------------------------------------------------------------------------
  config:
    runs-on: ubuntu-latest
    outputs:
      php_src_repo: ${{ steps.read.outputs.php_src_repo }}
      php_src_branch: ${{ steps.read.outputs.php_src_branch }}
      async_repo: ${{ steps.read.outputs.async_repo }}
      async_branch: ${{ steps.read.outputs.async_branch }}
      xdebug_repo: ${{ steps.read.outputs.xdebug_repo }}
      xdebug_branch: ${{ steps.read.outputs.xdebug_branch }}
      version: ${{ steps.read.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Read build-config.json
        id: read
        run: |
          echo "php_src_repo=$(jq -r '.php_src.repo' build-config.json)" >> "$GITHUB_OUTPUT"
          echo "php_src_branch=$(jq -r '.php_src.branch' build-config.json)" >> "$GITHUB_OUTPUT"
          echo "async_repo=$(jq -r '.extensions.async.repo' build-config.json)" >> "$GITHUB_OUTPUT"
          echo "async_branch=$(jq -r '.extensions.async.branch' build-config.json)" >> "$GITHUB_OUTPUT"
          echo "xdebug_repo=$(jq -r '.extensions.xdebug.repo' build-config.json)" >> "$GITHUB_OUTPUT"
          echo "xdebug_branch=$(jq -r '.extensions.xdebug.branch' build-config.json)" >> "$GITHUB_OUTPUT"
          VERSION="${GITHUB_REF_NAME#v}"
          if [[ "$VERSION" == "$GITHUB_REF_NAME" ]]; then
            VERSION="dev-$(date +%Y%m%d-%H%M%S)"
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

  # ---------------------------------------------------------------------------
  # Linux x64 build
  # ---------------------------------------------------------------------------
  build-linux:
    needs: config
    runs-on: ubuntu-22.04
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4

      - name: Checkout php-src
        uses: actions/checkout@v4
        with:
          repository: ${{ needs.config.outputs.php_src_repo }}
          ref: ${{ needs.config.outputs.php_src_branch }}
          path: php-src

      - name: Checkout ext/async
        uses: actions/checkout@v4
        with:
          repository: ${{ needs.config.outputs.async_repo }}
          ref: ${{ needs.config.outputs.async_branch }}
          path: php-src/ext/async

      - name: Checkout xdebug
        uses: actions/checkout@v4
        with:
          repository: ${{ needs.config.outputs.xdebug_repo }}
          ref: ${{ needs.config.outputs.xdebug_branch }}
          path: xdebug

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            autoconf automake bison re2c pkg-config \
            build-essential curl cmake ninja-build \
            libxml2-dev libsqlite3-dev libcurl4-openssl-dev \
            libssl-dev libzip-dev zlib1g-dev \
            libpq-dev libonig-dev libsodium-dev \
            libreadline-dev libbz2-dev \
            libgmp-dev libicu-dev libxslt1-dev \
            libjpeg-dev libwebp-dev libfreetype6-dev libpng-dev \
            libtidy-dev libldap2-dev \
            libgettextpo-dev libargon2-dev

          # Build libuv 1.48.0 from source
          wget https://github.com/libuv/libuv/archive/v1.48.0.tar.gz
          tar -xzf v1.48.0.tar.gz
          cd libuv-1.48.0
          mkdir build && cd build
          cmake .. -G Ninja -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTING=OFF
          ninja
          sudo ninja install
          sudo ldconfig

      - name: Build PHP
        working-directory: php-src
        run: |
          COMMON_FLAGS=$(jq -r '.configure.common | join(" ")' ../build-config.json)
          LINUX_FLAGS=$(jq -r '.configure.linux | join(" ")' ../build-config.json)

          ./buildconf --force
          ./configure \
            --prefix=/opt/php-trueasync \
            $COMMON_FLAGS \
            $LINUX_FLAGS

          make -j$(nproc)

      - name: Run ext/async tests
        working-directory: php-src
        run: |
          PHP_BIN="$(pwd)/sapi/cli/php"
          echo "Running ext/async tests..."
          "$PHP_BIN" run-tests.php --show-diff -p "$PHP_BIN" ext/async/tests/
          echo "All ext/async tests passed."

      - name: Install PHP
        working-directory: php-src
        run: |
          sudo make install

      - name: Build xdebug
        working-directory: xdebug
        run: |
          /opt/php-trueasync/bin/phpize
          ./configure --with-php-config=/opt/php-trueasync/bin/php-config
          make -j$(nproc)
          sudo make install

      - name: Verify build
        run: |
          /opt/php-trueasync/bin/php -v
          /opt/php-trueasync/bin/php -m

      - name: Package
        run: |
          VERSION="${{ needs.config.outputs.version }}"
          ARCHIVE="php-trueasync-${VERSION}-linux-x64.tar.gz"

          cd /opt
          tar czf "${GITHUB_WORKSPACE}/${ARCHIVE}" php-trueasync/
          echo "ARCHIVE=${ARCHIVE}" >> "$GITHUB_ENV"

      - name: Upload artifact
        if: ${{ !inputs.test_only }}
        uses: actions/upload-artifact@v4
        with:
          name: linux-x64
          path: ${{ env.ARCHIVE }}
          retention-days: 5

  # ---------------------------------------------------------------------------
  # Windows x64 build
  # ---------------------------------------------------------------------------
  build-windows:
    needs: config
    runs-on: windows-2022
    timeout-minutes: 60
    env:
      PHP_BUILD_CACHE_BASE_DIR: C:\build-cache
      PHP_BUILD_OBJ_DIR: C:\obj
      PHP_BUILD_CACHE_SDK_DIR: C:\build-cache\sdk
      PHP_BUILD_SDK_BRANCH: php-sdk-2.3.0
      PHP_BUILD_CRT: vs17
      PLATFORM: x64
      THREAD_SAFE: "1"
    steps:
      - name: git config
        run: git config --global core.autocrlf false && git config --global core.eol lf

      - uses: actions/checkout@v4

      - name: Checkout php-src
        uses: actions/checkout@v4
        with:
          repository: ${{ needs.config.outputs.php_src_repo }}
          ref: ${{ needs.config.outputs.php_src_branch }}
          path: php-src

      - name: Checkout ext/async
        uses: actions/checkout@v4
        with:
          repository: ${{ needs.config.outputs.async_repo }}
          ref: ${{ needs.config.outputs.async_branch }}
          path: async

      - name: Copy async extension to ext/async
        shell: cmd
        run: |
          if not exist php-src\ext\async mkdir php-src\ext\async
          xcopy /E /I /H /Y async php-src\ext\async

      - name: Checkout xdebug
        uses: actions/checkout@v4
        with:
          repository: ${{ needs.config.outputs.xdebug_repo }}
          ref: ${{ needs.config.outputs.xdebug_branch }}
          path: xdebug

      - name: Setup LibUV
        shell: powershell
        run: |
          if (!(Test-Path "C:\vcpkg")) {
            git clone https://github.com/Microsoft/vcpkg.git C:\vcpkg
            C:\vcpkg\bootstrap-vcpkg.bat
          }
          C:\vcpkg\vcpkg.exe install libuv:x64-windows

      - name: Setup PHP SDK
        shell: cmd
        run: |
          if not exist "%PHP_BUILD_CACHE_BASE_DIR%" mkdir "%PHP_BUILD_CACHE_BASE_DIR%"
          if not exist "%PHP_BUILD_OBJ_DIR%" mkdir "%PHP_BUILD_OBJ_DIR%"
          git clone --branch %PHP_BUILD_SDK_BRANCH% --depth 1 https://github.com/php/php-sdk-binary-tools.git "%PHP_BUILD_CACHE_SDK_DIR%"

      - name: Build PHP
        shell: cmd
        run: |
          cd php-src

          for /f "usebackq tokens=3" %%i in (`findstr PHP_MAJOR_VERSION main\php_version.h`) do set BRANCH=%%i
          for /f "usebackq tokens=3" %%i in (`findstr PHP_MINOR_VERSION main\php_version.h`) do set BRANCH=%BRANCH%.%%i
          if /i "%BRANCH%" equ "8.5" set BRANCH=master

          set SDK_RUNNER=%PHP_BUILD_CACHE_SDK_DIR%\phpsdk-%PHP_BUILD_CRT%-%PLATFORM%.bat
          set STABILITY=staging
          set DEPS_DIR=%PHP_BUILD_CACHE_BASE_DIR%\deps-%BRANCH%-%PHP_BUILD_CRT%-%PLATFORM%

          REM Download PHP deps via SDK
          cmd /c %SDK_RUNNER% -t "phpsdk_deps --update --no-backup --branch %BRANCH% --stability %STABILITY% --deps %DEPS_DIR% --crt %PHP_BUILD_CRT%"

          REM Copy LibUV from vcpkg to deps directory
          if not exist "%DEPS_DIR%\include\libuv" mkdir "%DEPS_DIR%\include\libuv"
          if not exist "%DEPS_DIR%\lib" mkdir "%DEPS_DIR%\lib"
          if not exist "%DEPS_DIR%\bin" mkdir "%DEPS_DIR%\bin"
          copy "C:\vcpkg\installed\x64-windows\include\uv.h" "%DEPS_DIR%\include\libuv\uv.h"
          xcopy /E /I /H /Y "C:\vcpkg\installed\x64-windows\include\uv" "%DEPS_DIR%\include\libuv\uv\"
          copy "C:\vcpkg\installed\x64-windows\lib\uv.lib" "%DEPS_DIR%\lib\libuv.lib"
          copy "C:\vcpkg\installed\x64-windows\bin\uv.dll" "%DEPS_DIR%\bin\uv.dll"

          REM Build PHP
          cmd /c %SDK_RUNNER% -t "cd %cd% && call buildconf.bat --force && call configure.bat --enable-snapshot-build --disable-debug-pack --enable-object-out-dir=%PHP_BUILD_OBJ_DIR% --with-php-build=%DEPS_DIR% --enable-async --with-prefix=C:\php-trueasync && nmake /NOLOGO"

      - name: Run ext/async tests
        shell: cmd
        run: |
          set PHP_BIN=%PHP_BUILD_OBJ_DIR%\Release_TS\php.exe
          echo Running ext/async tests...
          "%PHP_BIN%" php-src\run-tests.php --show-diff -p "%PHP_BIN%" php-src\ext\async\tests\
          echo All ext/async tests passed.

      - name: Install PHP
        shell: cmd
        run: |
          cd php-src
          set SDK_RUNNER=%PHP_BUILD_CACHE_SDK_DIR%\phpsdk-%PHP_BUILD_CRT%-%PLATFORM%.bat
          cmd /c %SDK_RUNNER% -t "cd %cd% && nmake install"

      - name: Build xdebug
        shell: cmd
        run: |
          cd php-src

          for /f "usebackq tokens=3" %%i in (`findstr PHP_MAJOR_VERSION main\php_version.h`) do set BRANCH=%%i
          for /f "usebackq tokens=3" %%i in (`findstr PHP_MINOR_VERSION main\php_version.h`) do set BRANCH=%BRANCH%.%%i
          if /i "%BRANCH%" equ "8.5" set BRANCH=master

          set SDK_RUNNER=%PHP_BUILD_CACHE_SDK_DIR%\phpsdk-%PHP_BUILD_CRT%-%PLATFORM%.bat
          set DEPS_DIR=%PHP_BUILD_CACHE_BASE_DIR%\deps-%BRANCH%-%PHP_BUILD_CRT%-%PLATFORM%

          REM Find phpize in the installed PHP
          set PHPIZE=C:\php-trueasync\SDK\phpize.bat
          if not exist "%PHPIZE%" set PHPIZE=C:\php-trueasync\devel\phpize.bat
          if not exist "%PHPIZE%" (
            echo Looking for phpize.bat...
            dir /s /b C:\php-trueasync\phpize.bat 2>nul
            echo ERROR: phpize.bat not found
            exit /b 1
          )

          cd %GITHUB_WORKSPACE%\xdebug
          cmd /c %SDK_RUNNER% -t "cd %cd% && call "%PHPIZE%" && call configure.bat --with-php-build=%DEPS_DIR% --enable-xdebug && nmake /NOLOGO && nmake install"

      - name: Package
        run: |
          $version = "${{ needs.config.outputs.version }}"
          $archive = "php-trueasync-${version}-windows-x64.zip"

          # Copy libuv DLL to the install directory
          $branch = (Select-String -Path php-src\main\php_version.h -Pattern "PHP_MAJOR_VERSION" | Select-Object -First 1).Line -replace '.*\s(\d+)$','$1'
          $minor = (Select-String -Path php-src\main\php_version.h -Pattern "PHP_MINOR_VERSION" | Select-Object -First 1).Line -replace '.*\s(\d+)$','$1'
          $depsDir = "C:\build-cache\deps-${branch}.${minor}-vs17-x64"
          if ("${branch}.${minor}" -eq "8.5") { $depsDir = "C:\build-cache\deps-master-vs17-x64" }

          if (Test-Path "$depsDir\bin\uv.dll") {
            Copy-Item "$depsDir\bin\uv.dll" "C:\php-trueasync\" -ErrorAction SilentlyContinue
          }

          Compress-Archive -Path "C:\php-trueasync\*" -DestinationPath "${env:GITHUB_WORKSPACE}\${archive}"
          echo "ARCHIVE=${archive}" >> $env:GITHUB_ENV
        shell: pwsh

      - name: Upload artifact
        if: ${{ !inputs.test_only }}
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64
          path: ${{ env.ARCHIVE }}
          retention-days: 5

  # ---------------------------------------------------------------------------
  # Create GitHub Release with checksums
  # ---------------------------------------------------------------------------
  release:
    if: ${{ !inputs.test_only }}
    needs: [config, build-linux, build-windows]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Collect release files
        run: |
          mkdir -p release-files
          find artifacts -type f \( -name "*.tar.gz" -o -name "*.zip" \) -exec cp {} release-files/ \;
          ls -la release-files/

      - name: Generate SHA256 checksums
        run: |
          cd release-files
          sha256sum * > sha256sums.txt
          cat sha256sums.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "TrueAsync PHP ${{ needs.config.outputs.version }}"
          body: |
            ## TrueAsync PHP ${{ needs.config.outputs.version }}

            PHP with built-in TrueAsync support and Xdebug.

            ### Included extensions
            - **async** — TrueAsync coroutine engine
            - **xdebug** — Debugger and profiler

            ### Installation

            **Linux:**
            ```bash
            curl -fsSL https://raw.githubusercontent.com/true-async/releases/main/installer/install.sh | bash
            ```

            **Windows (PowerShell):**
            ```powershell
            irm https://raw.githubusercontent.com/true-async/releases/main/installer/install.ps1 | iex
            ```

            ### Verify
            ```bash
            php -v
            php -m | grep async
            ```

            ### Checksums
            See `sha256sums.txt` for SHA256 checksums of all files.
          files: release-files/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
