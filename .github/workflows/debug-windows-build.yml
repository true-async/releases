name: Debug Windows Build (artifact dump)

on:
  workflow_dispatch:

jobs:
  build-debug-dump:
    name: "Windows x64 Debug (php-src@true-async + php-async@main)"
    runs-on: windows-2022
    timeout-minutes: 60
    env:
      PHP_BUILD_CACHE_BASE_DIR: C:\build-cache
      PHP_BUILD_OBJ_DIR: C:\obj
      PHP_BUILD_CACHE_SDK_DIR: C:\build-cache\sdk
      PHP_BUILD_SDK_BRANCH: php-sdk-2.3.0
      PHP_BUILD_CRT: vs17
      PLATFORM: x64
      THREAD_SAFE: "1"
    steps:
      - name: git config
        run: git config --global core.autocrlf false && git config --global core.eol lf

      - uses: actions/checkout@v4

      - name: Checkout php-src
        uses: actions/checkout@v4
        with:
          repository: true-async/php-src
          ref: true-async
          path: php-src

      - name: Checkout ext/async
        uses: actions/checkout@v4
        with:
          repository: true-async/php-async
          ref: main
          path: async

      - name: Copy async extension to ext/async
        shell: cmd
        run: |
          if not exist php-src\ext\async mkdir php-src\ext\async
          xcopy /E /I /H /Y async php-src\ext\async

      - name: Setup LibUV
        shell: powershell
        run: |
          if (!(Test-Path "C:\vcpkg")) {
            git clone https://github.com/Microsoft/vcpkg.git C:\vcpkg
            C:\vcpkg\bootstrap-vcpkg.bat
          }
          C:\vcpkg\vcpkg.exe install libuv:x64-windows-static-md

      - name: Setup PHP SDK
        shell: cmd
        run: |
          if not exist "%PHP_BUILD_CACHE_BASE_DIR%" mkdir "%PHP_BUILD_CACHE_BASE_DIR%"
          if not exist "%PHP_BUILD_OBJ_DIR%" mkdir "%PHP_BUILD_OBJ_DIR%"
          git clone --branch %PHP_BUILD_SDK_BRANCH% --depth 1 https://github.com/php/php-sdk-binary-tools.git "%PHP_BUILD_CACHE_SDK_DIR%"

      - name: Detect PHP branch and download deps
        shell: cmd
        run: |
          cd php-src
          for /f "usebackq tokens=3" %%i in (`findstr PHP_MAJOR_VERSION main\php_version.h`) do set BRANCH=%%i
          for /f "usebackq tokens=3" %%i in (`findstr PHP_MINOR_VERSION main\php_version.h`) do set BRANCH=%BRANCH%.%%i
          if /i "%BRANCH%" equ "8.5" set BRANCH=master

          echo BRANCH=%BRANCH%>> %GITHUB_ENV%

          set DEPS_DIR=%PHP_BUILD_CACHE_BASE_DIR%\deps-%BRANCH%-%PHP_BUILD_CRT%-%PLATFORM%
          echo DEPS_DIR=%DEPS_DIR%>> %GITHUB_ENV%

          set SDK_RUNNER=%PHP_BUILD_CACHE_SDK_DIR%\phpsdk-%PHP_BUILD_CRT%-%PLATFORM%.bat

          > %GITHUB_WORKSPACE%\task_deps.bat echo @echo off
          >> %GITHUB_WORKSPACE%\task_deps.bat echo phpsdk_deps --update --no-backup --branch %BRANCH% --stability staging --deps %DEPS_DIR% --crt %PHP_BUILD_CRT%
          >> %GITHUB_WORKSPACE%\task_deps.bat echo if %%errorlevel%% neq 0 exit /b 3

          cmd /c %SDK_RUNNER% -t %GITHUB_WORKSPACE%\task_deps.bat
          if %errorlevel% neq 0 exit /b %errorlevel%

          if not exist "%DEPS_DIR%\include\libuv" mkdir "%DEPS_DIR%\include\libuv"
          if not exist "%DEPS_DIR%\lib" mkdir "%DEPS_DIR%\lib"
          if not exist "%DEPS_DIR%\bin" mkdir "%DEPS_DIR%\bin"
          copy "C:\vcpkg\installed\x64-windows-static-md\include\uv.h" "%DEPS_DIR%\include\libuv\uv.h"
          xcopy /E /I /H /Y "C:\vcpkg\installed\x64-windows-static-md\include\uv" "%DEPS_DIR%\include\libuv\uv\"
          copy "C:\vcpkg\installed\x64-windows-static-md\lib\libuv.lib" "%DEPS_DIR%\lib\libuv.lib"

      - name: Build PHP (Debug)
        shell: pwsh
        run: |
          @(
            "@echo off",
            "cd /d $($env:GITHUB_WORKSPACE)\php-src",
            "if %errorlevel% neq 0 exit /b 3",
            "call buildconf.bat --force",
            "if %errorlevel% neq 0 exit /b 3",
            "call configure.bat --enable-debug --enable-object-out-dir=%PHP_BUILD_OBJ_DIR% --with-php-build=%DEPS_DIR% --enable-async",
            "if %errorlevel% neq 0 exit /b 3",
            "nmake /NOLOGO",
            "if %errorlevel% neq 0 exit /b 3",
            "exit /b 0"
          ) | Set-Content -Path "$env:GITHUB_WORKSPACE\task_build.bat" -Encoding ASCII

          $SDK_RUNNER = "$env:PHP_BUILD_CACHE_SDK_DIR\phpsdk-$env:PHP_BUILD_CRT-$env:PLATFORM.bat"
          cmd /c $SDK_RUNNER -t $env:GITHUB_WORKSPACE\task_build.bat
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

      - name: Run ext/async tests
        shell: cmd
        run: |
          set PHP_BIN=%PHP_BUILD_OBJ_DIR%\Debug_TS\php.exe

          REM Copy dependency DLLs next to php.exe so it can find them
          copy "%DEPS_DIR%\bin\*.dll" "%PHP_BUILD_OBJ_DIR%\Debug_TS\"

          echo Running ext/async tests...
          "%PHP_BIN%" php-src\run-tests.php --show-diff -p "%PHP_BIN%" php-src\ext\async\tests\
          if %errorlevel% neq 0 exit /b %errorlevel%
          echo All ext/async tests passed.

      - name: Upload build directory as artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-debug-build
          path: C:\obj\Debug_TS\
          retention-days: 3
